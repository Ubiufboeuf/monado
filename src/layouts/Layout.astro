---
import '../styles/global.css'
import Header from '@/components/Header/Header.astro'
import { Menu } from '@/components/Menu'
import { MenuMini } from '@/components/MenuMini'
import { TabBar } from '@/components/TabBar'
import { ClientRouter } from 'astro:transitions'

interface Props {
  title?: string
	menuMini?: boolean
	tabBar?: boolean
	useTransitions?: boolean
}

const { title, menuMini, tabBar, useTransitions = true } = Astro.props

const isMenuOpen = Astro.cookies.get('monado-is-menu-open')?.value
const inCinemaMode = Astro.cookies.get('monado-in-cinema-mode')?.value

const deviceCodeCookie = Astro.cookies.get('monado-device-type')
const deviceCode = deviceCodeCookie?.value

const devices = { 
  'M': 'mobile', 
  'T': 'tablet', 
  'D': 'desktop'
}

const deviceType = devices[deviceCode as keyof typeof devices] ?? 'desktop'
const { pathname } = Astro.url
---

<html
	lang='es'
	data-device-type={deviceType}
	data-in-cinema-mode={inCinemaMode === 'true'}
	class='not-full-screen:gutter-stable'
>
	<head>
		<meta charset='utf-8' />
		<link rel='icon' type='image/svg+xml' href='/favicon.svg' />
		<meta name='viewport' content='width=device-width' />
		<title>{title ? `${title} - Monado` : 'Monado'}</title>
    <script>
      (function() {
        const htmlElement = document.documentElement;
        
        // El servidor ya puso un valor (ej: 'is-desktop-ua').
        const currentDeviceType = htmlElement.dataset.deviceType; 
        
        // Función auxiliar para establecer cookies
        function setCookie(name: string, value: string, days: number) {
          const date = new Date();
          date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
          const expires = `; expires=${date.toUTCString()}`;
          document.cookie = `${name}=${value}${expires}; path=/; SameSite=Lax`;
        }
        
        // Mapeo inverso de la clase CSS al código de 1 byte
        const devices = { 
					'M': 'mobile',
					'T': 'tablet',
					'D': 'desktop'
        };
        
        // --- Lógica de detección del dispositivo en base al user agent ---
        const ua = navigator.userAgent;
        const mobileRegex = /(Mobi|Android(?!.*Nexus 7)|iPhone|iPod|Windows Phone|BlackBerry|Symbian|IEMobile|Opera Mini|Fennec|webOS|hpwos|avantgo|bada|blazer|compal|elaine|hiptop|kindle|lge|maemo|midp|mmp|netfront|palm|phone|plucker|pocket|psp|series60|treo|up\.browser|up\.link|vodafone|wap|windows ce|xda|xiino)/i;
        const tabletRegex = /(iPad|Android(?!.*mobile)|Kindle|Playbook|Silk|Tablet|hpw|webos|Nexus 7)/i;
        
        let newDeviceCode = 'D'; // Por defecto: Desktop

        if (mobileRegex.test(ua) && !/iPad/i.test(ua)) {
          newDeviceCode = 'M'; // Mobile
        } else if (tabletRegex.test(ua)) {
          newDeviceCode = 'T'; // Tablet
        }
        
        const newDeviceType = devices[newDeviceCode as keyof typeof devices];
        
        // --- Optimización: Solo actualizar si hay discrepancia ---
        if (currentDeviceType !== newDeviceType) {
					// Aplicar el cambio en el DOM para evitar flasheo
					htmlElement.dataset.deviceType = newDeviceType;

					// Guardar la cookie para que el servidor la use en la próxima carga
					setCookie('monado-device-type', newDeviceCode, 30);
        }
      })()
    </script>
		<script>
			// Leer cookie del estado del menú
			(function() {
				const isMenuOpen = document.cookie
					.split('; ')
					.find(c => c.startsWith('monado-is-menu-open='))
					?.split('=')[1] || 'false'
				const input = document.querySelector('#checkbox-menu-state') as HTMLInputElement
				if (input) input.checked = (isMenuOpen === 'true')
			})()
		</script>
		<script>
			function handleGlobalChange(event: Event) {
				const input = event.target
				if (!(input instanceof HTMLInputElement)) return
				if (!input.matches('#checkbox-menu-state')) return

				document.cookie = `monado-is-menu-open=${input.checked}; path=/; Secure; SameSite=Strict`
			}

			function handlePageLoad () {
				const cookie = document.cookie
					.split('; ')
					.find((c) => c.includes('monado-is-menu-open='))
					?.split('=')
					?.[1]

				const input = document.querySelector('#checkbox-menu-state')
				if (input instanceof HTMLInputElement) {
					input.checked = cookie === 'true'
				}

				const cinemaCookie = document.cookie
					.split('; ')
					.find((c) => c.includes('monado-in-cinema-mode='))
					?.split('=')
					?.[1]

				const savedCinemaMode = cinemaCookie === 'true'

				if (savedCinemaMode) document.documentElement.dataset.inCinemaMode = 'true'
				else delete document.documentElement.dataset.inCinemaMode
			}

			document.addEventListener('change', handleGlobalChange)
			document.addEventListener('astro:page-load', handlePageLoad)
		</script>
		{ useTransitions && <ClientRouter /> }
	</head>
	<body class='flex flex-col bg-base-dark'>
		<input id='checkbox-menu-state' type='checkbox' hidden checked={isMenuOpen === 'true'} />
		<Header />
		<main class='h-full w-full min-h-fit max-h-full pt-14'>
			<Menu pathname={pathname} client:load transition:persist />
			<MenuMini hidden={!menuMini} />
			<slot />
		</main>
		<TabBar hidden={!tabBar} />
	</body>
</html>
